<%- include('partials/header') %>

<script>
    window.CHAPTER_DATA = {
        novelId: "<%= novel._id %>",
        chapterId: "<%= chapter._id %>",
        chapterOrder: "<%= chapter.order %>",
        settingText: <%- JSON.stringify(chapter.visual_setting_text || '') %>,
        prompts: {
            visual_setting: <%- JSON.stringify(novel.prompts && novel.prompts.visual_setting ? novel.prompts.visual_setting : "") %>
        }
    };
</script>

<div class="flex h-[calc(100vh-64px)] overflow-hidden bg-slate-50" x-data="settingApp()">
    
    <div x-show="previewUrl" 
         class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/90 backdrop-blur-sm"
         @click.self="closePreview()"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         style="display: none;">
         
         <div class="relative max-w-[90vw] max-h-[90vh] flex flex-col items-center p-2">
             <button @click="closePreview()" class="absolute -top-12 right-0 text-white/70 hover:text-white transition-colors p-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
             </button>
             <img :src="previewUrl" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl bg-[#202020] object-contain border border-white/10">
             <div class="mt-4 text-white/50 text-xs font-mono">é¢„è§ˆæ¨¡å¼ â€¢ style.png</div>
         </div>
    </div>

    <%- include('partials/chapter_sidebar') %>

    <div class="flex-1 flex flex-col min-w-0 bg-white relative">
        <div class="px-8 py-4 border-b border-slate-100 flex justify-between items-center bg-white flex-shrink-0 h-16">
            <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <span>ğŸ¨</span> <span>è§†è§‰è®¾å®š</span>
            </h2>
            <div class="flex items-center gap-4">
                <span x-show="isSaving" class="text-xs text-purple-500 bg-purple-50 px-2 py-1 rounded animate-pulse" style="display: none;">ä¿å­˜ä¸­...</span>
                <a href="/novel/<%= novel._id %>/prompts?tab=setting" target="_blank" class="text-xs font-medium text-slate-500 hover:text-indigo-600 bg-slate-50 hover:bg-indigo-50 px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-200 transition flex items-center gap-1.5 group">
                    <span class="group-hover:rotate-45 transition-transform duration-300">âš™ï¸</span> é…ç½®æç¤ºè¯æ¨¡ç‰ˆ
                </a>
            </div>
        </div>

        <div class="flex-1 overflow-hidden relative bg-slate-50/30">
            <div class="absolute inset-0 p-6 grid grid-cols-2 gap-6 overflow-hidden">
                
                <div class="flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 h-full overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-100 bg-purple-50/30 flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-purple-900">ğŸ¨ è§†è§‰è®¾å®šæè¿°</span>
                        </div>
                        <button @click="generatePrompt()" class="px-3 py-1.5 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition shadow-sm flex items-center gap-1">
                            <span>âœ¨</span> ç”Ÿæˆæç¤ºè¯
                        </button>
                    </div>
                    <textarea 
                        x-model="settingText"
                        @input.debounce.1000ms="saveSettingText()"
                        class="flex-1 w-full p-5 resize-none outline-none text-sm text-slate-700 font-mono bg-white leading-relaxed placeholder-slate-300 custom-scrollbar" 
                        placeholder="åœ¨æ­¤è¾“å…¥æ‚¨æ„æ€çš„è§†è§‰è®¾å®šï¼ˆè§’è‰²å¤–è²Œã€åœºæ™¯é£æ ¼ã€ç”»é£è¦æ±‚ç­‰ï¼‰..."></textarea>
                </div>

                <div class="flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 h-full overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center flex-shrink-0">
                        <span class="text-sm font-bold text-slate-700">ğŸš€ æœ€ç»ˆæç¤ºè¯</span>
                        
                        <div class="flex items-center gap-2">
                            <img :src="styleImageUrl" @load="hasStyleImage=true" @error="hasStyleImage=false" class="hidden">

                            <button x-show="hasStyleImage" 
                                    @click="openPreview(styleImageUrl)"
                                    x-transition
                                    class="flex items-center gap-1 px-2 py-1 bg-indigo-50 text-indigo-600 border border-indigo-200 text-xs rounded hover:bg-indigo-600 hover:text-white transition-colors shadow-sm">
                                <span>ğŸ‘ï¸</span> <span class="hidden sm:inline">é¢„è§ˆ</span>
                            </button>

                            <label class="flex items-center gap-1 px-2 py-1 bg-white border border-slate-300 text-slate-600 text-xs rounded hover:bg-orange-600 hover:text-white hover:border-orange-600 transition-colors shadow-sm cursor-pointer group/upload relative overflow-hidden"
                                   :class="{'!bg-green-50 !text-green-600 !border-green-200': uploadStatus === 'success', '!bg-red-50 !text-red-600': uploadStatus === 'error', 'pointer-events-none opacity-80': uploadStatus === 'uploading'}">
                                
                                <span x-show="uploadStatus === 'idle' || uploadStatus === 'uploading'" class="group-hover/upload:text-white flex items-center gap-1">
                                    <span x-show="uploadStatus === 'uploading'" class="animate-spin">â³</span>
                                    <span x-show="uploadStatus !== 'uploading'">ğŸ“¤</span>
                                    <span>ä¸Šä¼ å›¾</span>
                                </span>
                                <span x-show="uploadStatus === 'success'">âœ… æˆåŠŸ</span>
                                <span x-show="uploadStatus === 'error'">âŒ å¤±è´¥</span>

                                <input type="file" class="hidden" accept="image/*" @change="uploadStyle($event)">
                            </label>

                            <button @click="copyResult()" class="flex items-center gap-1 px-3 py-1 bg-white border border-slate-300 text-slate-600 text-xs rounded hover:bg-slate-800 hover:text-white hover:border-slate-800 transition-colors shadow-sm" x-ref="copyBtn">
                                <span>ğŸ“‹</span> å¤åˆ¶
                            </button>
                        </div>
                    </div>
                    <textarea id="settingOutput" class="flex-1 w-full p-5 resize-none outline-none text-sm text-green-400 font-mono bg-slate-900 leading-relaxed custom-scrollbar" placeholder="ç‚¹å‡»å·¦ä¾§ 'ç”Ÿæˆæç¤ºè¯' æŒ‰é’®..."></textarea>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('settingApp', () => ({
            settingText: window.CHAPTER_DATA.settingText,
            isSaving: false,
            
            // å›¾ç‰‡ç›¸å…³çŠ¶æ€
            hasStyleImage: false,
            timestamp: Date.now(),
            uploadStatus: 'idle',
            previewUrl: null,

            // åŠ¨æ€è®¡ç®— style.png åœ°å€ (å¸¦æ—¶é—´æˆ³é˜²ç¼“å­˜)
            get styleImageUrl() {
                return `/images/${window.CHAPTER_DATA.novelId}/ep${window.CHAPTER_DATA.chapterOrder}/style.png?v=${this.timestamp}`;
            },

            saveSettingText() {
                this.isSaving = true;
                fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/save_setting_text`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: this.settingText })
                }).then(() => this.isSaving = false);
            },

            // ä¸Šä¼  Style Image
            async uploadStyle(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.uploadStatus = 'uploading';
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result;
                    try {
                        // è°ƒç”¨åç«¯ upload_style æ¥å£
                        const res = await fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/upload_style`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: base64 })
                        });
                        const json = await res.json();
                        
                        if (json.success) {
                            this.uploadStatus = 'success';
                            this.timestamp = Date.now(); // åˆ·æ–°å›¾ç‰‡ç¼“å­˜
                        } else {
                            this.uploadStatus = 'error';
                            alert(json.message);
                        }
                    } catch (err) {
                        this.uploadStatus = 'error';
                        console.error(err);
                    } finally {
                        setTimeout(() => { 
                            this.uploadStatus = 'idle';
                            event.target.value = ''; 
                        }, 2000);
                    }
                };
                reader.readAsDataURL(file);
            },

            generatePrompt() {
                const content = this.settingText || "";
                const template = window.CHAPTER_DATA.prompts.visual_setting || "";
                let fullPrompt = template.includes("{content}") ? template.replace(/{content}/g, content) : (template + "\n\n" + content);
                const outputEl = document.getElementById('settingOutput');
                outputEl.value = fullPrompt; 
                outputEl.focus();
            },

            copyResult() {
                const output = document.getElementById('settingOutput');
                output.select();
                navigator.clipboard.writeText(output.value).then(() => {
                    const btn = this.$refs.copyBtn;
                    const originalHtml = btn.innerHTML; 
                    btn.innerHTML = 'âœ… å·²å¤åˆ¶';
                    btn.classList.add('text-green-600', 'border-green-600');
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.classList.remove('text-green-600', 'border-green-600');
                    }, 1000);
                });
            },

            // é¢„è§ˆç›¸å…³
            openPreview(url) { this.previewUrl = url; },
            closePreview() { this.previewUrl = null; }
        }));
    });
</script>
<%- include('partials/footer') %>