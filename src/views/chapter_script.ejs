<%- include('partials/header') %>

<script>
    window.CHAPTER_DATA = {
        prompts: {
            script: <%- JSON.stringify(novel.prompts && novel.prompts.script ? novel.prompts.script : "") %>,
            visual: <%- JSON.stringify(novel.prompts && novel.prompts.visual ? novel.prompts.visual : "") %>
        }
    };
</script>

<div class="flex h-[calc(100vh-64px)] overflow-hidden bg-slate-50" x-data="scriptApp()">
    <%- include('partials/chapter_sidebar') %>

    <div class="flex-1 flex flex-col min-w-0 bg-white relative">
        <div class="px-8 py-4 border-b border-slate-100 flex justify-between items-center bg-white flex-shrink-0 h-16">
            <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <span>📝</span> <span>提示词生成</span>
            </h2>
            <div class="flex items-center gap-4">
                <a href="/novel/<%= novel._id %>/prompts?tab=script" target="_blank" class="text-xs font-medium text-slate-500 hover:text-indigo-600 bg-slate-50 hover:bg-indigo-50 px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-200 transition flex items-center gap-1.5 group">
                    <span class="group-hover:rotate-45 transition-transform duration-300">⚙️</span> 配置提示词模版
                </a>
            </div>
        </div>

        <div class="flex-1 overflow-hidden relative bg-slate-50/30">
            <div class="absolute inset-0 p-6 grid grid-cols-2 gap-6 overflow-hidden">
                <div class="flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 h-full overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center flex-shrink-0">
                        <span class="text-sm font-bold text-slate-700">📜 小说原文</span>
                        <div class="flex gap-2">
                            <button @click="generatePrompt('script')" class="px-3 py-1.5 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700 transition shadow-sm flex items-center gap-1">
                                <span>🎬</span> 生成剧本Prompt
                            </button>
                            <button @click="generatePrompt('visual')" class="px-3 py-1.5 bg-pink-600 text-white text-xs rounded hover:bg-pink-700 transition shadow-sm flex items-center gap-1">
                                <span>👁️</span> 生成视觉Prompt
                            </button>
                        </div>
                    </div>
                    <textarea id="sourceContent" class="flex-1 w-full p-4 resize-none outline-none text-sm text-slate-700 font-mono bg-white leading-relaxed custom-scrollbar" readonly><%= chapter.content %></textarea>
                </div>
            
                <div class="flex flex-col bg-slate-800 rounded-xl shadow-lg border border-slate-700 h-full overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center flex-shrink-0">
                        <span class="text-sm font-bold text-slate-300">生成的提示词</span>
                        <button @click="copyResult()" class="text-xs text-slate-300 hover:text-white border border-slate-600 px-2 py-1 rounded transition-all min-w-[60px] text-center" x-ref="copyBtn">复制</button>
                    </div>
                    <textarea id="resultOutput" class="flex-1 w-full p-4 resize-none outline-none text-xs text-green-400 font-mono bg-slate-800 custom-scrollbar" placeholder="点击左侧按钮，AI 提示词将在这里生成..."></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('scriptApp', () => ({
            generatePrompt(type) {
                const content = document.getElementById('sourceContent').value || "";
                const template = window.CHAPTER_DATA.prompts[type] || "";
                let fullPrompt = template.includes("{content}") ? template.replace(/{content}/g, content) : (template + "\n\n" + content);
                const outputEl = document.getElementById('resultOutput');
                if (outputEl) { outputEl.value = fullPrompt; outputEl.focus(); }
            },
            copyResult() {
                const output = document.getElementById('resultOutput');
                output.select();
                navigator.clipboard.writeText(output.value).then(() => {
                    const btn = this.$refs.copyBtn;
                    const originalText = btn.innerText; 
                    btn.innerText = '✅';
                    setTimeout(() => btn.innerText = originalText, 1000);
                });
            }
        }));
    });
</script>
<%- include('partials/footer') %>