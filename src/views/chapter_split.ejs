<%- include('partials/header') %>

<script>
    window.CHAPTER_DATA = {
        novelId: "<%= novel._id %>",
        chapterId: "<%= chapter._id %>",
        chapterOrder: "<%= chapter.order %>"
    };
</script>

<div class="flex h-[calc(100vh-64px)] overflow-hidden bg-slate-50" x-data="splitApp()">
    <%- include('partials/chapter_sidebar') %>

    <div class="flex-1 flex flex-col min-w-0 bg-white relative">
        <div class="px-8 py-4 border-b border-slate-100 flex justify-between items-center bg-white flex-shrink-0 h-16">
            <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <span>✂️</span> <span>图片分割</span>
            </h2>
        </div>

        <div class="flex-1 overflow-hidden relative bg-slate-50/30">
            <div class="absolute inset-0 flex items-center justify-center p-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 w-full max-w-2xl p-8 text-center" x-data="{ processing: false, logs: [] }">
                    <div class="w-20 h-20 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl">✂️</div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">图片自动分割工具</h2>
                    <p class="text-slate-500 mb-8 max-w-md mx-auto leading-relaxed text-sm">
                        系统将读取 <code>ep<%= chapter.order %></code> 目录下的所有 PNG 图片。<br>
                        普通图片按 <span class="text-orange-600 font-mono bg-orange-50 px-1 rounded">2x2</span> 格式切割为 4 张 JPG；
                        结果存入 <span class="font-mono bg-slate-100 px-1 rounded">ext/</span> 目录。
                    </p>

                    <button @click="startSplit()" :disabled="processing" :class="{'opacity-75 cursor-wait': processing}" class="px-8 py-3 bg-orange-600 text-white rounded-lg text-lg font-bold shadow-lg hover:bg-orange-700 transition-all transform active:scale-95 flex items-center justify-center gap-3 mx-auto">
                        <span x-show="!processing">🚀 开始分割处理</span>
                        <span x-show="processing">处理中...</span>
                    </button>

                    <div x-show="logs.length > 0" class="mt-8 text-left bg-slate-900 rounded-lg p-4 font-mono text-xs text-green-400 max-h-48 overflow-y-auto shadow-inner" style="display: none;">
                        <template x-for="log in logs"><div class="mb-1 border-b border-slate-800 pb-1 last:border-0" x-text="log"></div></template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('splitApp', () => ({
            processing: false,
            logs: [],
            startSplit() {
                this.processing = true;
                this.logs = ['正在请求服务器处理...'];
                fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/split_images`, { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            this.logs.push('✅ ' + data.message);
                            this.logs.push(`📂 存放路径: assets/outputs/images/${window.CHAPTER_DATA.novelId}/ep${window.CHAPTER_DATA.chapterOrder}/ext/`);
                        } else { this.logs.push('❌ 失败: ' + data.message); }
                    })
                    .catch(e => this.logs.push('❌ 网络错误: ' + e.message))
                    .finally(() => this.processing = false);
            }
        }));
    });
</script>
<%- include('partials/footer') %>