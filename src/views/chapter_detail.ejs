<%- include('partials/header') %>

<div class="flex flex-col h-[calc(100vh-64px-32px)]" x-data="{ activeTab: 'text' }"> 
    
    <div class="flex items-center justify-between mb-4 flex-shrink-0">
        <div class="text-sm text-slate-500">
            <span class="font-bold text-slate-800"><%= chapter.title %></span>
            <span class="mx-2">|</span>
            <span class="text-slate-400"><%= novel.title %></span>
        </div>

        <div class="bg-slate-200 p-1 rounded-lg flex text-sm font-medium">
            <button @click="activeTab = 'text'" 
                :class="{ 'bg-white text-slate-800 shadow-sm': activeTab === 'text', 'text-slate-500 hover:text-slate-700': activeTab !== 'text' }"
                class="px-4 py-1.5 rounded-md transition-all flex items-center gap-2">
                <span>📝</span> 提示词生成
            </button>
            <button @click="activeTab = 'cards'" 
                :class="{ 'bg-white text-blue-600 shadow-sm': activeTab === 'cards', 'text-slate-500 hover:text-slate-700': activeTab !== 'cards' }"
                class="px-4 py-1.5 rounded-md transition-all flex items-center gap-2">
                <span>🎬</span> 分镜制作 (<%= chapter.script_data ? chapter.script_data.length : 0 %>)
            </button>
        </div>
        
        <div class="w-24"></div> </div>

    <div class="flex-1 min-h-0 relative">
        
        <div x-show="activeTab === 'text'" class="absolute inset-0 grid grid-cols-2 gap-6">
            <div class="flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <span class="text-sm font-bold text-slate-700">📜 小说原文</span>
                    <div class="flex gap-2">
                        <button onclick="generatePrompt('script')" class="px-3 py-1.5 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700 transition shadow-sm flex items-center gap-1">
                            <span>🎬</span> 生成剧本Prompt
                        </button>
                        <button onclick="generatePrompt('visual')" class="px-3 py-1.5 bg-pink-600 text-white text-xs rounded hover:bg-pink-700 transition shadow-sm flex items-center gap-1">
                            <span>🎨</span> 生成视觉Prompt
                        </button>
                    </div>
                </div>
                <textarea id="sourceContent" class="flex-1 w-full p-4 resize-none outline-none text-sm text-slate-700 font-mono bg-white leading-relaxed" readonly><%= chapter.content %></textarea>
            </div>
            
            <div class="flex flex-col bg-slate-800 rounded-xl shadow-lg border border-slate-700 overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center">
                    <span class="text-sm font-bold text-slate-300">生成的提示词 (复制给大模型)</span>
                    <button onclick="copyResult(this)" class="text-xs text-slate-300 hover:text-white border border-slate-600 px-2 py-1 rounded transition-all min-w-[60px] text-center">复制</button>
                </div>
                <textarea id="resultOutput" class="flex-1 w-full p-4 resize-none outline-none text-xs text-green-400 font-mono bg-slate-800" placeholder="点击左侧按钮，根据配置的模板生成 Prompt..."></textarea>
            </div>
        </div>

        <div x-show="activeTab === 'cards'" class="absolute inset-0 flex flex-col gap-4" style="display: none;">
            
            <div class="flex-shrink-0 bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex gap-4 items-start" x-data="{ expanded: false }">
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold text-slate-700">📥 导入 JSON 脚本</span>
                        <button @click="expanded = !expanded" class="text-xs text-blue-600 hover:underline" x-text="expanded ? '收起' : '展开输入框'"></button>
                    </div>
                    
                    <form id="jsonForm" action="/chapter/<%= chapter._id %>/import" method="POST" x-show="expanded" class="transition-all">
                        <textarea name="rawScript" placeholder='在此粘贴大模型生成的 JSON 代码...' 
                                  class="w-full h-32 p-3 text-xs font-mono border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none mb-2"></textarea>
                        <button type="submit" class="px-4 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 font-medium">
                            解析并生成卡片
                        </button>
                    </form>
                    <div x-show="!expanded" class="text-xs text-slate-400">
                        点击右上角“展开输入框”以粘贴新的 JSON 数据。
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto bg-slate-100/50 rounded-xl border border-slate-200 p-4">
                <% if (!chapter.script_data || chapter.script_data.length === 0) { %>
                    <div class="h-full flex flex-col items-center justify-center text-slate-400">
                        <p class="text-2xl mb-2">📭</p>
                        <p class="text-sm">暂无卡片，请展开上方输入框粘贴 JSON。</p>
                    </div>
                <% } else { %>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 pb-20">
                        <% chapter.script_data.forEach((panel, index) => { %>
                        <div class="bg-white rounded-lg shadow-sm border border-slate-200 flex overflow-hidden group hover:shadow-md transition-shadow h-48">
                            
                            <div class="w-[200px] bg-slate-50 border-r border-slate-100 relative flex-shrink-0 cursor-pointer group/img"
                                 onclick="window.open(this.querySelector('img').src, '_blank')">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 text-xs text-center p-2 break-all">
                                    <span class="text-xl mb-1">🖼️</span>
                                    <span class="scale-90 font-mono opacity-60">ep<%= chapter.order %>/<%= index %>.png</span>
                                </div>
                                <img src="/images/<%= novel._id %>/ep<%= chapter.order %>/<%= index %>.png" 
                                     onerror="this.style.display='none'"
                                     class="absolute inset-0 w-full h-full object-cover z-10 bg-slate-200 hover:scale-105 transition duration-500">
                                <div class="absolute top-2 left-2 z-20 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded font-mono backdrop-blur-sm">
                                    <%= panel.id %>
                                </div>
                            </div>

                            <div class="flex-1 flex flex-col min-w-0">
                                <div class="px-4 py-2 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
                                    <span class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100 text-[10px]">
                                        <%= panel.composition || '未知景别' %>
                                    </span>
                                    <button onclick="copyPanelPrompt('<%= chapter._id %>', '<%= panel.id %>', this)" 
                                            class="text-xs bg-white border border-slate-200 text-slate-600 px-2 py-1 rounded hover:border-blue-500 hover:text-blue-600 transition flex items-center gap-1">
                                        <span>🎨</span> 复制生图词
                                    </button>
                                </div>

                                <div class="p-3 space-y-2 overflow-y-auto text-sm text-slate-700">
                                    <div>
                                        <p class="leading-snug text-slate-800 text-xs"><%= panel.visual || '-' %></p>
                                    </div>
                                    <% if (panel.env) { %>
                                    <div>
                                        <span class="text-[10px] text-slate-400">环境:</span>
                                        <span class="text-[10px] text-slate-500"><%= panel.env %></span>
                                    </div>
                                    <% } %>
                                    <% if (panel.lines && panel.lines.length > 0) { %>
                                    <div class="bg-yellow-50/50 rounded p-1.5 border border-yellow-100/50 space-y-1">
                                        <% panel.lines.forEach(line => { %>
                                            <div class="text-[10px] flex gap-1">
                                                <span class="font-bold text-yellow-700 flex-shrink-0"><%= line.role %>:</span>
                                                <span class="text-slate-600 truncate"><%= line.content %></span>
                                            </div>
                                        <% }) %>
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
    // [核心] 从后端获取配置的 Templates
    // 使用 JSON.stringify 安全地传递多行文本和特殊字符
    const NOVEL_PROMPTS = {
        script: <%- JSON.stringify(novel.prompts && novel.prompts.script ? novel.prompts.script : "") %>,
        visual: <%- JSON.stringify(novel.prompts && novel.prompts.visual ? novel.prompts.visual : "") %>,
        image: <%- JSON.stringify(novel.prompts && novel.prompts.panel ? novel.prompts.panel : "") %>
    };

    // 通用生成函数
    window.generatePrompt = function(type) {
        const content = document.getElementById('sourceContent').value;
        const template = NOVEL_PROMPTS[type] || "";
        
        // 替换 {content}
        let fullPrompt = "";
        if (template.includes("{content}")) {
            fullPrompt = template.replace(/{content}/g, content);
        } else {
            fullPrompt = template + "\n\n" + content;
        }

        document.getElementById('resultOutput').value = fullPrompt;
        document.getElementById('resultOutput').focus();
    };

    // 复制结果
    window.copyResult = function(btn) {
        const output = document.getElementById('resultOutput');
        output.select();
        navigator.clipboard.writeText(output.value).then(() => {
            const originalText = btn.innerText;
            btn.innerText = '✅ 已复制';
            btn.classList.add('text-green-400', 'border-green-500');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('text-green-400', 'border-green-500');
            }, 2000);
        });
    };
    
    // 提交 JSON 表单
    function submitJsonForm() {
        document.getElementById('jsonForm').submit();
    }
    
    // AJAX 复制生图 Prompt
    window.copyPanelPrompt = async function(chapterId, panelId, btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = '⌛ ...';
        
        try {
            const res = await fetch(`/chapter/${chapterId}/panel/${panelId}/prompt`);
            const json = await res.json();
            
            if (json.success) {
                await navigator.clipboard.writeText(json.data);
                btn.innerHTML = '✅ 已复制';
                btn.classList.add('text-green-600', 'border-green-500');
            } else {
                btn.innerHTML = '❌ 失败';
            }
        } catch (e) {
            console.error(e);
            btn.innerHTML = '❌ 错误';
        }

        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('text-green-600', 'border-green-500');
        }, 2000);
    };
</script>

<%- include('partials/footer') %>