<%- include('partials/header') %>

<script>
    window.CHAPTER_DATA = {
        novelId: "<%= novel._id %>",
        chapterId: "<%= chapter._id %>",
        chapterOrder: "<%= chapter.order %>",
        panels: <%- JSON.stringify(chapter.script_data || []) %> // è¿™é‡Œçš„ panels å®é™…ä¸Šæ˜¯ pages
    };
</script>

<div class="flex h-[calc(100vh-64px)] overflow-hidden bg-slate-50" x-data="panelsApp()">
    <%- include('partials/chapter_sidebar') %>

    <div class="flex-1 flex flex-col min-w-0 bg-white relative">
        <div class="px-8 py-4 border-b border-slate-100 flex justify-between items-center bg-white flex-shrink-0 h-16">
            <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <span>ğŸ¬</span> <span>åˆ†é•œåˆ¶ä½œ (Page Mode)</span>
            </h2>
            <div class="flex items-center gap-4">
                <a href="/novel/<%= novel._id %>/prompts?tab=image" target="_blank" class="text-xs font-medium text-slate-500 hover:text-indigo-600 bg-slate-50 hover:bg-indigo-50 px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-200 transition flex items-center gap-1.5 group">
                    <span class="group-hover:rotate-45 transition-transform duration-300">âš™ï¸</span> é…ç½®æç¤ºè¯æ¨¡ç‰ˆ
                </a>
            </div>
        </div>

        <div class="flex-1 overflow-hidden relative bg-slate-50/30">
            <div class="absolute inset-0 p-6 grid grid-cols-12 gap-6 overflow-hidden">
                <div class="col-span-5 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 h-full overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-100 bg-blue-50/30 flex justify-between items-center flex-shrink-0">
                        <span class="text-sm font-bold text-slate-700">ğŸ“¥ å¯¼å…¥ JSON è„šæœ¬</span>
                        <button @click="importScript()" :disabled="isSubmitting" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition shadow-sm flex items-center gap-1 disabled:opacity-50">
                            <span x-show="!isSubmitting">ğŸš€ è§£æ Pages</span>
                            <span x-show="isSubmitting">â³ è§£æä¸­...</span>
                        </button>
                    </div>
                    <div class="flex-1 flex flex-col relative group">
                        <textarea x-model="rawScript" @input="saveScriptCache()" id="jsonInput" 
                            class="absolute inset-0 w-full h-full p-4 text-xs font-mono resize-none outline-none text-slate-600 bg-white border-0 custom-scrollbar leading-relaxed" 
                            placeholder='è¯·ç²˜è´´ JSON æ•°æ®ï¼Œç³»ç»Ÿå°†æŒ‰ "pages" æ•°ç»„ç”Ÿæˆå¡ç‰‡ã€‚'></textarea>
                        <div x-show="errorMsg" class="absolute bottom-4 left-4 right-4 px-3 py-2 bg-red-100 text-red-700 text-xs rounded border border-red-200 shadow-sm flex items-center gap-2" style="display: none;" x-transition>
                            <span>âš ï¸</span> <span x-text="errorMsg"></span>
                        </div>
                    </div>
                </div>

                <div class="col-span-7 flex flex-col bg-slate-100/50 rounded-xl border border-slate-200 h-full overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-white flex justify-between items-center flex-shrink-0">
                        <span class="text-sm font-bold text-slate-700">ğŸ¬ é¡µé¢é¢„è§ˆ</span>
                        <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full" x-text="'å…± ' + panels.length + ' é¡µ'"></span>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                        <div x-show="panels.length === 0" class="h-full flex flex-col items-center justify-center text-slate-400">
                            <div class="text-4xl mb-2 opacity-30">ğŸ“­</div>
                            <p class="text-sm">è¯·åœ¨å·¦ä¾§è§£æ JSON æ•°æ®</p>
                        </div>
                        <template x-for="(panel, index) in panels" :key="index">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden group hover:border-blue-400 transition-all mb-4">
                                <div class="px-4 py-2 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-mono font-bold text-slate-700 bg-slate-200 px-1.5 py-0.5 rounded" x-text="'PAGE ' + panel.id"></span>
                                        <span class="text-[10px] text-slate-400" x-text="'åŒ…å« ' + (JSON.parse(panel.visual).panels?.length || 0) + ' ä¸ªåˆ†é•œ'"></span>
                                    </div>
                                    <button @click="copyPanelPrompt(panel.id, $el)" 
                                            class="flex items-center gap-1 px-2 py-1 bg-white border border-slate-200 text-slate-600 text-xs rounded hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-colors shadow-sm">
                                        <span>ğŸ“‹</span> å¤åˆ¶æ•´é¡µ JSON
                                    </button>
                                </div>
                                
                                <div class="flex h-64">
                                    <div class="flex-1 p-4 text-[10px] text-slate-600 font-mono whitespace-pre-wrap leading-tight select-text overflow-y-auto custom-scrollbar bg-slate-50/50" x-text="panel.visual"></div>
                                    
                                    <div class="w-40 bg-slate-100 relative cursor-pointer group/img border-l border-slate-100 flex-shrink-0" @click="openImage(index)">
                                        <img :src="getImageUrl(index)" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" class="absolute inset-0 w-full h-full object-cover transition-transform group-hover/img:scale-105">
                                        <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 bg-slate-100 hidden" style="display: none;">
                                            <span class="text-2xl mb-1">ğŸ–¼ï¸</span>
                                            <span class="text-xs font-mono" x-text="(index + 1) + '.png'"></span>
                                            <span class="text-[10px] mt-1 opacity-50">ç‚¹å‡»æŸ¥çœ‹å¤§å›¾</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('panelsApp', () => ({
            panels: window.CHAPTER_DATA.panels,
            rawScript: localStorage.getItem(`aimanga_script_cache_${window.CHAPTER_DATA.chapterId}`) || '',
            isSubmitting: false,
            errorMsg: '',

            saveScriptCache() {
                localStorage.setItem(`aimanga_script_cache_${window.CHAPTER_DATA.chapterId}`, this.rawScript);
            },

            async importScript() {
                if (!this.rawScript.trim()) return;
                this.isSubmitting = true;
                this.errorMsg = '';
                try {
                    const res = await fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rawScript: this.rawScript }) 
                    });
                    const result = await res.json();
                    if (result.success) {
                        this.panels = result.data;
                    } else { this.errorMsg = result.message; }
                } catch (err) { this.errorMsg = "ç½‘ç»œè¯·æ±‚å‡ºé”™"; } finally { this.isSubmitting = false; }
            },

            getImageUrl(index) {
                // Page 1 -> 1.png
                return `/images/${window.CHAPTER_DATA.novelId}/ep${window.CHAPTER_DATA.chapterOrder}/${index + 1}.png`;
            },
            openImage(index) {
                window.open(this.getImageUrl(index), '_blank');
            },

            async copyPanelPrompt(panelId, btn) {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<span class="animate-spin">â³</span>';
                try {
                    // è¯·æ±‚åç«¯è·å–åˆå¹¶äº†æ¨¡ç‰ˆçš„å®Œæ•´ Prompt (è¿™é‡Œå†…å®¹æ˜¯æ•´é¡µ JSON)
                    const res = await fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/panel/${panelId}/prompt`);
                    const json = await res.json();
                    if (json.success) {
                        await navigator.clipboard.writeText(json.data);
                        btn.innerHTML = 'âœ… å·²å¤åˆ¶';
                        btn.classList.add('text-green-600', 'border-green-600');
                    } else { 
                        btn.innerHTML = 'âŒ å¤±è´¥'; 
                    }
                } catch (e) { 
                    btn.innerHTML = 'âŒ é”™è¯¯'; 
                }
                setTimeout(() => { 
                    btn.innerHTML = originalHtml; 
                    btn.classList.remove('text-green-600', 'border-green-600');
                }, 1500);
            }
        }));
    });
</script>
<%- include('partials/footer') %>