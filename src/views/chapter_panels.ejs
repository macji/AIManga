<%- include('partials/header') %>

<script>
    window.CHAPTER_DATA = {
        novelId: "<%= novel._id %>",
        chapterId: "<%= chapter._id %>",
        chapterOrder: "<%= chapter.order %>",
        panels: <%- JSON.stringify(chapter.script_data || []) %>
    };
</script>

<div class="flex h-[calc(100vh-64px)] overflow-hidden bg-slate-50" x-data="panelsApp()">
    
    <div x-show="previewUrl" 
         class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/90 backdrop-blur-sm"
         @click.self="closePreview()"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         style="display: none;">
         
         <div class="relative max-w-[90vw] max-h-[90vh] flex flex-col items-center p-2">
             <button @click="closePreview()" class="absolute -top-12 right-0 text-white/70 hover:text-white transition-colors p-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
             </button>
             <img :src="previewUrl" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl bg-[#202020] object-contain border border-white/10">
             <div class="mt-4 text-white/50 text-xs font-mono">È¢ÑËßàÊ®°Âºè ‚Ä¢ ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠</div>
         </div>
    </div>

    <%- include('partials/chapter_sidebar') %>

    <div class="flex-1 flex flex-col min-w-0 bg-white relative">
        <div class="px-8 py-4 border-b border-slate-100 flex justify-between items-center bg-white flex-shrink-0 h-16">
            <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <span>üé¨</span> <span>ÂàÜÈïúÂà∂‰Ωú (Page Mode)</span>
            </h2>
            
            <div class="flex items-center gap-4">
                <a href="/novel/<%= novel._id %>/prompts?tab=image" target="_blank" class="text-xs font-medium text-slate-500 hover:text-indigo-600 bg-slate-50 hover:bg-indigo-50 px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-200 transition flex items-center gap-1.5 group">
                    <span class="group-hover:rotate-45 transition-transform duration-300">‚öôÔ∏è</span> ÈÖçÁΩÆÊèêÁ§∫ËØçÊ®°Áâà
                </a>
            </div>
        </div>

        <div class="flex-1 overflow-hidden relative bg-slate-50/30">
            <div class="absolute inset-0 p-6 grid grid-cols-12 gap-6 overflow-hidden">
                <div class="col-span-5 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 h-full overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-100 bg-blue-50/30 flex justify-between items-center flex-shrink-0">
                        <span class="text-sm font-bold text-slate-700">üì• ÂØºÂÖ• JSON ËÑöÊú¨</span>
                        <button @click="importScript()" :disabled="isSubmitting" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition shadow-sm flex items-center gap-1 disabled:opacity-50">
                            <span x-show="!isSubmitting">üöÄ Ëß£Êûê Pages</span>
                            <span x-show="isSubmitting">‚è≥ Ëß£Êûê‰∏≠...</span>
                        </button>
                    </div>
                    <div class="flex-1 flex flex-col relative group">
                        <textarea x-model="rawScript" @input="saveScriptCache()" id="jsonInput" 
                            class="absolute inset-0 w-full h-full p-4 text-xs font-mono resize-none outline-none text-slate-600 bg-white border-0 custom-scrollbar leading-relaxed" 
                            placeholder='ËØ∑Á≤òË¥¥ JSON Êï∞ÊçÆÔºåÁ≥ªÁªüÂ∞ÜÊåâ "pages" Êï∞ÁªÑÁîüÊàêÂç°Áâá„ÄÇ'></textarea>
                        <div x-show="errorMsg" class="absolute bottom-4 left-4 right-4 px-3 py-2 bg-red-100 text-red-700 text-xs rounded border border-red-200 shadow-sm flex items-center gap-2" style="display: none;" x-transition>
                            <span>‚ö†Ô∏è</span> <span x-text="errorMsg"></span>
                        </div>
                    </div>
                </div>

                <div class="col-span-7 flex flex-col bg-slate-100/50 rounded-xl border border-slate-200 h-full overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-white flex justify-between items-center flex-shrink-0">
                        <span class="text-sm font-bold text-slate-700">üé¨ È°µÈù¢È¢ÑËßà</span>
                        <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full" x-text="'ÂÖ± ' + panels.length + ' È°µ'"></span>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                        
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden mb-6 group hover:border-indigo-400 transition-all">
                            <div class="px-4 py-3 border-b border-slate-100 bg-indigo-50/30 flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">üë§</span>
                                    <span class="text-sm font-bold text-slate-700">ËßíËâ≤ÂèÇËÄÉÂõæ (Characters)</span>
                                </div>
                                <label class="flex items-center gap-1 px-3 py-1.5 bg-white border border-slate-200 text-slate-600 text-xs rounded hover:bg-indigo-600 hover:text-white hover:border-indigo-600 transition-colors shadow-sm cursor-pointer group/upload relative overflow-hidden"
                                       :class="{'!bg-green-50 !text-green-600 !border-green-200': charUploadStatus === 'success', '!bg-red-50 !text-red-600': charUploadStatus === 'error', 'pointer-events-none opacity-80': charUploadStatus === 'uploading'}">
                                     <span x-show="charUploadStatus === 'idle' || charUploadStatus === 'uploading'" class="group-hover/upload:text-white flex items-center gap-1">
                                         <span x-show="charUploadStatus === 'uploading'" class="animate-spin">‚è≥</span>
                                         <span x-show="charUploadStatus !== 'uploading'">üì§</span>
                                         <span>‰∏ä‰º†ËßíËâ≤ (ÊîØÊåÅÂ§öÈÄâ)</span>
                                     </span>
                                     <span x-show="charUploadStatus === 'success'">‚úÖ ‰∏ä‰º†ÊàêÂäü</span>
                                     <span x-show="charUploadStatus === 'error'">‚ùå Â§±Ë¥•</span>
                                     <input type="file" class="hidden" accept="image/*" multiple @change="uploadCharacters($event)">
                                </label>
                            </div>
                            
                            <div class="p-4 bg-slate-50/50">
                                <div x-show="characters.length === 0" class="text-center py-6 text-slate-400 text-xs border-2 border-dashed border-slate-200 rounded-lg">
                                    ÊöÇÊó†ËßíËâ≤ÂõæÔºåËØ∑ÁÇπÂáªÂè≥‰∏äËßí‰∏ä‰º†
                                </div>
                                <div class="grid grid-cols-4 sm:grid-cols-5 gap-3" x-show="characters.length > 0">
                                    <template x-for="char in characters" :key="char.name">
                                        <div class="group/char relative aspect-square bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden cursor-pointer" @click="openPreview(char.url)">
                                            <img :src="char.url" class="w-full h-full object-cover group-hover/char:scale-110 transition-transform duration-500">
                                            <div class="absolute inset-0 bg-black/0 group-hover/char:bg-black/10 transition-colors"></div>
                                            <div class="absolute bottom-0 inset-x-0 bg-black/60 backdrop-blur-sm px-1 py-1 text-[10px] text-white text-center truncate" x-text="char.name"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div x-show="panels.length === 0" class="h-40 flex flex-col items-center justify-center text-slate-400">
                            <div class="text-2xl mb-2 opacity-30">üì≠</div>
                            <p class="text-sm">ËØ∑Âú®Â∑¶‰æßËß£Êûê JSON Êï∞ÊçÆ‰ª•ÁîüÊàêÂàÜÈïúÈ°µ</p>
                        </div>
                        
                        <template x-for="(panel, index) in panels" :key="index">
                            <div x-data="panelRow(index + 1)" 
                                 class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden group hover:border-blue-400 transition-all mb-4">
                                <img :src="imageUrl" @load="hasImage=true" @error="hasImage=false" class="hidden">
                                <div class="px-4 py-2 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-mono font-bold text-slate-700 bg-slate-200 px-1.5 py-0.5 rounded" x-text="'PAGE ' + panel.id"></span>
                                        <span class="text-[10px] text-slate-400" x-text="'ÂåÖÂê´ ' + (JSON.parse(panel.visual).panels?.length || 0) + ' ‰∏™ÂàÜÈïú'"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button x-show="hasImage" @click="openPreview(imageUrl)" x-transition class="flex items-center gap-1 px-2 py-1 bg-indigo-50 text-indigo-600 border border-indigo-200 text-xs rounded hover:bg-indigo-600 hover:text-white transition-colors shadow-sm">
                                            <span>üëÅÔ∏è</span> <span class="hidden sm:inline">È¢ÑËßà</span>
                                        </button>
                                        <label class="flex items-center gap-1 px-2 py-1 bg-white border border-slate-200 text-slate-600 text-xs rounded hover:bg-orange-600 hover:text-white hover:border-orange-600 transition-colors shadow-sm cursor-pointer group/upload relative overflow-hidden"
                                               :class="{'!bg-green-50 !text-green-600 !border-green-200': uploadStatus === 'success', '!bg-red-50 !text-red-600': uploadStatus === 'error', 'pointer-events-none opacity-80': uploadStatus === 'uploading'}">
                                            <span x-show="uploadStatus === 'idle' || uploadStatus === 'uploading'" class="group-hover/upload:text-white flex items-center gap-1">
                                                <span x-show="uploadStatus === 'uploading'" class="animate-spin">‚è≥</span>
                                                <span x-show="uploadStatus !== 'uploading'">üì§</span>
                                                <span>‰∏ä‰º†Âõæ</span>
                                            </span>
                                            <span x-show="uploadStatus === 'success'">‚úÖ ÊàêÂäü</span>
                                            <span x-show="uploadStatus === 'error'">‚ùå Â§±Ë¥•</span>
                                            <input type="file" class="hidden" accept="image/*" @change="upload($event)">
                                        </label>
                                        <button @click="copyPanelPrompt(panel.id, $el)" class="flex items-center gap-1 px-2 py-1 bg-white border border-slate-200 text-slate-600 text-xs rounded hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-colors shadow-sm">
                                            <span>üìã</span> Â§çÂà∂ JSON
                                        </button>
                                    </div>
                                </div>
                                <div class="flex h-64">
                                    <div class="flex-1 p-4 text-[10px] text-slate-600 font-mono whitespace-pre-wrap leading-tight select-text overflow-y-auto custom-scrollbar bg-slate-50/50" x-text="panel.visual"></div>
                                </div>
                            </div>
                        </template>

                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden mb-8 mt-6">
                            <div class="px-4 py-3 border-b border-slate-100 bg-purple-50/30 flex items-center gap-2">
                                <span class="text-lg">üìö</span>
                                <span class="text-sm font-bold text-slate-700">‰π¶Á±çË£ÖÂ∏ß (Â∞ÅÈù¢/Â∞ÅÂ∫ï)</span>
                            </div>
                            <div class="flex flex-col divide-y divide-slate-100">
                                <div x-data="panelRow(0)" class="p-4 flex justify-between items-center hover:bg-slate-50 transition-colors group">
                                     <img :src="imageUrl" @load="hasImage=true" @error="hasImage=false" class="hidden">
                                     <div class="flex items-center gap-3">
                                         <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-sm shadow-sm">0</div>
                                         <div class="flex flex-col">
                                             <span class="text-xs font-bold text-slate-700 group-hover:text-purple-600 transition-colors">Â∞ÅÈù¢ (Front Cover)</span>
                                             <span class="text-[10px] text-slate-400 font-mono">Êñá‰ª∂Âêç: 0.png</span>
                                         </div>
                                     </div>
                                     <div class="flex items-center gap-2">
                                         <button x-show="hasImage" @click="openPreview(imageUrl)" x-transition class="flex items-center gap-1 px-3 py-1.5 bg-indigo-50 text-indigo-600 border border-indigo-200 text-xs rounded hover:bg-indigo-600 hover:text-white transition-colors shadow-sm">
                                             <span>üëÅÔ∏è</span> <span class="hidden sm:inline">È¢ÑËßàÂ∞ÅÈù¢</span>
                                         </button>
                                         <label class="flex items-center gap-1 px-3 py-1.5 bg-white border border-slate-200 text-slate-600 text-xs rounded hover:bg-purple-600 hover:text-white hover:border-purple-600 transition-colors shadow-sm cursor-pointer group/upload relative overflow-hidden"
                                                :class="{'!bg-green-50 !text-green-600 !border-green-200': uploadStatus === 'success', '!bg-red-50 !text-red-600': uploadStatus === 'error', 'pointer-events-none opacity-80': uploadStatus === 'uploading'}">
                                             <span x-show="uploadStatus === 'idle' || uploadStatus === 'uploading'" class="group-hover/upload:text-white flex items-center gap-1">
                                                 <span x-show="uploadStatus === 'uploading'" class="animate-spin">‚è≥</span>
                                                 <span x-show="uploadStatus !== 'uploading'">üì§</span>
                                                 <span>‰∏ä‰º†Â∞ÅÈù¢</span>
                                             </span>
                                             <span x-show="uploadStatus === 'success'">‚úÖ ÊàêÂäü</span>
                                             <span x-show="uploadStatus === 'error'">‚ùå Â§±Ë¥•</span>
                                             <input type="file" class="hidden" accept="image/*" @change="upload($event)">
                                         </label>
                                     </div>
                                </div>
                                <div x-data="panelRow(99)" class="p-4 flex justify-between items-center hover:bg-slate-50 transition-colors group">
                                     <img :src="imageUrl" @load="hasImage=true" @error="hasImage=false" class="hidden">
                                     <div class="flex items-center gap-3">
                                         <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-sm shadow-sm">99</div>
                                         <div class="flex flex-col">
                                             <span class="text-xs font-bold text-slate-700 group-hover:text-slate-900 transition-colors">Â∞ÅÂ∫ï (Back Cover)</span>
                                             <span class="text-[10px] text-slate-400 font-mono">Êñá‰ª∂Âêç: 99.png</span>
                                         </div>
                                     </div>
                                     <div class="flex items-center gap-2">
                                         <button x-show="hasImage" @click="openPreview(imageUrl)" x-transition class="flex items-center gap-1 px-3 py-1.5 bg-indigo-50 text-indigo-600 border border-indigo-200 text-xs rounded hover:bg-indigo-600 hover:text-white transition-colors shadow-sm">
                                             <span>üëÅÔ∏è</span> <span class="hidden sm:inline">È¢ÑËßàÂ∞ÅÂ∫ï</span>
                                         </button>
                                         <label class="flex items-center gap-1 px-3 py-1.5 bg-white border border-slate-200 text-slate-600 text-xs rounded hover:bg-slate-700 hover:text-white hover:border-slate-700 transition-colors shadow-sm cursor-pointer group/upload relative overflow-hidden"
                                                :class="{'!bg-green-50 !text-green-600 !border-green-200': uploadStatus === 'success', '!bg-red-50 !text-red-600': uploadStatus === 'error', 'pointer-events-none opacity-80': uploadStatus === 'uploading'}">
                                             <span x-show="uploadStatus === 'idle' || uploadStatus === 'uploading'" class="group-hover/upload:text-white flex items-center gap-1">
                                                 <span x-show="uploadStatus === 'uploading'" class="animate-spin">‚è≥</span>
                                                 <span x-show="uploadStatus !== 'uploading'">üì§</span>
                                                 <span>‰∏ä‰º†Â∞ÅÂ∫ï</span>
                                             </span>
                                             <span x-show="uploadStatus === 'success'">‚úÖ ÊàêÂäü</span>
                                             <span x-show="uploadStatus === 'error'">‚ùå Â§±Ë¥•</span>
                                             <input type="file" class="hidden" accept="image/*" @change="upload($event)">
                                         </label>
                                     </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
    document.addEventListener('alpine:init', () => {
        // Âçï‰∏™È°µÈù¢ÁöÑÁÆ°ÁêÜÈÄªËæë
        Alpine.data('panelRow', (pageNum) => ({
            hasImage: false,
            timestamp: Date.now(),
            uploadStatus: 'idle',

            get imageUrl() {
                return `/images/${window.CHAPTER_DATA.novelId}/ep${window.CHAPTER_DATA.chapterOrder}/${pageNum}.png?v=${this.timestamp}`;
            },

            async upload(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.uploadStatus = 'uploading';
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result;
                    try {
                        const res = await fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/upload_page_image`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                image: base64, 
                                filename: `${pageNum}.png` 
                            })
                        });
                        const json = await res.json();
                        if (json.success) {
                            this.uploadStatus = 'success';
                            this.timestamp = Date.now(); 
                        } else {
                            this.uploadStatus = 'error';
                            alert(json.message);
                        }
                    } catch (err) {
                        this.uploadStatus = 'error';
                        console.error(err);
                    } finally {
                        setTimeout(() => { 
                            this.uploadStatus = 'idle';
                            event.target.value = ''; 
                        }, 2000);
                    }
                };
                reader.readAsDataURL(file);
            }
        }));

        // ÂÖ®Â±Ä App ÈÄªËæë
        Alpine.data('panelsApp', () => ({
            panels: window.CHAPTER_DATA.panels,
            rawScript: localStorage.getItem(`aimanga_script_cache_${window.CHAPTER_DATA.chapterId}`) || '',
            isSubmitting: false,
            errorMsg: '',
            previewUrl: null,
            
            // ËßíËâ≤Áõ∏ÂÖ≥Áä∂ÊÄÅ
            characters: [],
            charUploadStatus: 'idle',

            init() {
                this.fetchCharacters();
            },

            async fetchCharacters() {
                try {
                    const res = await fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/characters`);
                    const json = await res.json();
                    if (json.success) {
                        this.characters = json.data;
                    }
                } catch(e) { console.error('Failed to fetch characters', e); }
            },

            // ÊâπÈáè‰∏ä‰º†ËßíËâ≤
            async uploadCharacters(event) {
                const files = event.target.files;
                if (!files || files.length === 0) return;

                this.charUploadStatus = 'uploading';
                
                // ÈÄê‰∏™‰∏ä‰º†
                for (let i = 0; i < files.length; i++) {
                    await this.uploadSingleChar(files[i]);
                }

                this.charUploadStatus = 'success';
                this.fetchCharacters(); // Âà∑Êñ∞ÂàóË°®
                
                setTimeout(() => {
                    this.charUploadStatus = 'idle';
                    event.target.value = '';
                }, 2000);
            },

            async uploadSingleChar(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64 = e.target.result;
                        try {
                            await fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/upload_character`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    image: base64, 
                                    filename: file.name
                                })
                            });
                        } catch (err) { console.error(err); }
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            },

            openPreview(url) { this.previewUrl = url; },
            closePreview() { this.previewUrl = null; },

            saveScriptCache() {
                localStorage.setItem(`aimanga_script_cache_${window.CHAPTER_DATA.chapterId}`, this.rawScript);
            },

            async importScript() {
                if (!this.rawScript.trim()) return;
                this.isSubmitting = true;
                this.errorMsg = '';
                try {
                    const res = await fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rawScript: this.rawScript }) 
                    });
                    const result = await res.json();
                    if (result.success) {
                        this.panels = result.data;
                    } else { 
                        this.errorMsg = result.message; 
                    }
                } catch (err) { 
                    this.errorMsg = "ÁΩëÁªúËØ∑Ê±ÇÂá∫Èîô";
                } finally { 
                    this.isSubmitting = false; 
                }
            },

            async copyPanelPrompt(panelId, btn) {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<span class="animate-spin">‚è≥</span>';
                try {
                    const res = await fetch(`/chapter/${window.CHAPTER_DATA.chapterId}/panel/${panelId}/prompt`);
                    const json = await res.json();
                    if (json.success) {
                        await navigator.clipboard.writeText(json.data);
                        btn.innerHTML = '‚úÖ Â∑≤Â§çÂà∂';
                        btn.classList.add('text-green-600', 'border-green-600');
                    } else { 
                        btn.innerHTML = '‚ùå Â§±Ë¥•';
                    }
                } catch (e) { 
                    btn.innerHTML = '‚ùå ÈîôËØØ';
                }
                setTimeout(() => { 
                    btn.innerHTML = originalHtml; 
                    btn.classList.remove('text-green-600', 'border-green-600');
                }, 1500);
            }
        }));
    });
</script>
<%- include('partials/footer') %>